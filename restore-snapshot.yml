---
- name: Restore Hyper-V VM from Snapshot
  hosts: all
  gather_facts: no
  tasks:
    - name: Validate required variables
      fail:
        msg: "Both vm_name and snapshot_name are required"
      when: >
        (vm_name is not defined or vm_name == "" or vm_name | trim == "") or
        (snapshot_name is not defined or snapshot_name == "" or snapshot_name | trim == "")
      
    - name: Restore VM from snapshot
      win_shell: |
        $ErrorActionPreference = 'Continue'
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $ProgressPreference = 'SilentlyContinue'
        
        $vmName = '{{ vm_name }}'
        $snapshotName = '{{ snapshot_name }}'
        
        try {
            # Redirect all streams to ensure clean output
            $result = Restore-VMSnapshot -VMName $vmName -Name $snapshotName -Confirm:$false -ErrorAction Stop 2>&1
            
            # Success - output to stdout
            [Console]::WriteLine("SUCCESS: VM '$vmName' restored from snapshot '$snapshotName'")
            exit 0
        } catch {
            # Error - output to stdout (not stderr)
            [Console]::WriteLine("ERROR: Failed to restore snapshot for '$vmName' from '$snapshotName' - $($_.Exception.Message)")
            exit 1
        }
      register: restore_result
      args:
        executable: powershell.exe
      changed_when: restore_result.rc == 0
      failed_when: restore_result.rc != 0
      ignore_errors: yes
      
    - name: Display result
      debug:
        msg: "{{ restore_result.stdout_lines | default(['No output received']) }}"

